<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Add New Halal Spot | Halal Finder</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .small {
      font-size: 0.9rem;
      color: gray;
      text-align: center;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <div class="auth-page">
    <form class="auth-form" id="addspot-form">
      <h2>Add a New Halal Spot</h2>
      
      <input type="text" id="name" placeholder="Spot Name" required />
      <input type="text" id="address" placeholder="Address" required />
      <input type="text" id="type" placeholder="Type (e.g., Restaurant, Butcher)" required />
      <input type="number" id="rating" placeholder="Rating (1–5)" min="1" max="5" step="0.1" />
      
      <input type="text" id="lat" placeholder="Latitude (auto-filled)" readonly />
      <input type="text" id="lng" placeholder="Longitude (auto-filled)" readonly />
      <input type="text" id="image" placeholder="Image URL (optional)" />
      
      <button type="submit">Add Spot</button>
      <p class="small" id="location-status">Getting your location...</p>
    </form>

    <p id="message"></p>
  </div>

  <script>
    const msg = document.getElementById("message");
    const latInput = document.getElementById("lat");
    const lngInput = document.getElementById("lng");
    const statusText = document.getElementById("location-status");

    // Try to get user’s location
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          latInput.value = pos.coords.latitude.toFixed(6);
          lngInput.value = pos.coords.longitude.toFixed(6);
          statusText.textContent = "Location detected";
          statusText.style.color = "green";
        },
        (err) => {
          console.warn("Location error:", err);
          statusText.textContent = "Couldn't detect location. You can enter manually.";
          statusText.style.color = "orange";
          latInput.removeAttribute("readonly");
          lngInput.removeAttribute("readonly");
        }
      );
    } else {
      statusText.textContent = "Geolocation not supported by your browser.";
      statusText.style.color = "red";
      latInput.removeAttribute("readonly");
      lngInput.removeAttribute("readonly");
    }

    document.getElementById("addspot-form").addEventListener("submit", async (e) => {
      e.preventDefault();

      const token = localStorage.getItem("token");
      if (!token) {
        msg.textContent = "You must be logged in to add a spot!";
        msg.style.color = "red";
        setTimeout(() => (window.location.href = "login.html"), 1500);
        return;
      }

      const name = document.getElementById("name").value.trim();
      const address = document.getElementById("address").value.trim();
      const type = document.getElementById("type").value.trim();
      const rating = document.getElementById("rating").value.trim();
      const lat = latInput.value.trim();
      const lng = lngInput.value.trim();
      const image = document.getElementById("image").value.trim();

      if (!name || !address || !type) {
        msg.textContent = "Name, address, and type are required.";
        msg.style.color = "red";
        return;
      }

      try {
        const res = await fetch("/api/spots", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify({ name, address, type, rating, lat, lng, image }),
        });

        const data = await res.json();

        if (res.ok) {
          msg.textContent = "Spot added successfully! Redirecting...";
          msg.style.color = "green";
          setTimeout(() => (window.location.href = "index.html"), 1500);
        } else {
          msg.textContent = data.error || data.message || "Failed to add spot.";
          msg.style.color = "red";
        }
      } catch (err) {
        console.error(err);
        msg.textContent = "Server error. Please try again.";
        msg.style.color = "red";
      }
    });
  </script>
</body>
</html>
